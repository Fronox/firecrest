{% extends "demo_base.html" %}
{% block title %}List jobs{% endblock %}
{% block content %}
<style>
table {
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

td, th {
  border: 1px solid #dddddd;
  text-align: left;
  padding: 8px;
}

tr:nth-child(even) {
  background-color: #dddddd;
}
</style>

<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

<script type="text/javascript">

var stop_array = ["200","400"];

function is_object(obj){

  /*return obj == Object(obj);*/
  /* if the length is undefined, is because it is a dictionary*/
  /*return ( typeof obj.length === "undefined");*/
  var length = Object.keys(obj).length;
  console.log("Lenght of dictionary: "+length);
  return length != 0;

}

function redirectPost(url,data){

    var form = document.createElement('form');
    document.body.appendChild(form);
    form.method = 'post';
    form.action = url;
    for (var name in data) {
        var input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = data[name];
        form.appendChild(input);
    }
    form.submit();

}


function cancel_job(jobid, machinename, cancel_url){

    var cancel = confirm("Do you really want to cancel job "+jobid+"?");

    if (!cancel)
        return;

    $.ajax({
        type: 'POST',
        url: cancel_url+"/"+jobid+"?machine="+machinename,
        success: function(data){
            alert("JobID "+jobid+" has been cancelled");

            /*var checkProgress = setInterval(function() {
                update_progress("/tasks/"+data['task_id']+"?data=1");
                }, 2000);*/

	    /*$.redirect('jobs', {'machinename':'{{ machine }}'});*/
            /*redirectPost('jobs', {'machinename':'{{ machine }}'});*/
            var cookie = getCookie("oidc_id_token");
	    console.log(cookie);
            

	    
        },

        error: function(data){

            alert(data['description']+"\n"+data['error']);
        },


     });
}

function update_progress(task_url) {

      $.ajax({
        type: 'GET',
        url: task_url,
        success: function(data){
          $(".task").css("border-color","green");
          $(".task").css("border-style","solid");

          var resp = data['task']['data'];


          console.log(resp.length);
          console.log(resp);
          
          if(is_object(resp)){
		$(".task").text("You have active jobs");
		
                var row_number = 1; /*starts with 1, because 0 is table header*/
                for (var key in resp){
			if(resp.hasOwnProperty(key)){
				
				var table = document.getElementById("job_table");				

				var row = table.insertRow(row_number);

 				var jobid = row.insertCell(0);
				jobid.innerHTML = resp[key]["jobid"];
 				var name = row.insertCell(1);
				name.innerHTML = resp[key]["name"];
				
 				var nodelist = row.insertCell(2);
				nodelist.innerHTML = resp[key]["nodelist"];
 				var nodes = row.insertCell(3);
				nodes.innerHTML = resp[key]["nodes"];
 				var partition = row.insertCell(4);
				partition.innerHTML = resp[key]["partition"];
 				var start_time = row.insertCell(5);
				start_time.innerHTML = resp[key]["start_time"];
 				var state = row.insertCell(6);
				state.innerHTML = resp[key]["state"];				
 				var time = row.insertCell(7);
				time.innerHTML = resp[key]["time"];				
 				var time_left = row.insertCell(8);
				time_left.innerHTML = resp[key]["time_left"];
                                var _jobid = resp[key]["jobid"];
				
				var actions = row.insertCell(9);
				actions.innerHTML = "<a href='jobs/"+resp[key]["jobid"]+"?machine={{ machine }}'>View</a> | "+
						"<a href='cancel/"+resp[key]["jobid"]+"?machine={{ machine }}'>Cancel</a>";

				row_number+=1;

				
				
			}

		}                
	   }
           else{
		$(".task").text("You don't have active jobs");

           }

	   if(stop_array.indexOf(data["task"]["status"]) != -1)
		clearInterval(checkProgress);


       },


        error: function(data){
          $(".task").css("border-color","red");
          $(".task").css("border-style","solid");
          $( ".task" ).text("Error on submiting request\n"+data['error']);

          },
      });
}


</script>


{{ wtf.quick_form(form) }}
<br>
<br>

{% if response != None %}
    {% if response.status_code == 200 %}
      {# {{ response.json()['success'] }} #} 
      <br>
      You can check the details of this task <a href="{{ request.url_root }}tasks/{{ response.json()['task_id'] }}">here</a>
      <br><br>	

      <script>
        var checkProgress = setInterval(function() {
          update_progress("/tasks/{{ response.json()['task_id'] }}?data=1");
        }, 2000);
      </script>
      <div class="task"></div><br>

      <div class="job_list">
           	<table id="job_table">
			<tr><th>Job ID</th><th>Job Name</th><th>Node List</th><th>Nodes</th><th>Partition</th><th>Start Time</th><th>State</th><th>Time</th><th>Time Left</th><th>Options</th></td>
		</table>
      </div>
    {% else %}
      {{ response.json()['error'] }}
    {% endif %}
{% endif %} 



{% endblock %}
