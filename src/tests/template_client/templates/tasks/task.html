{% extends "demo_base.html" %}
{% block title %}FirecREST Tasks{% endblock %}
{% block content %}
<style>
table {
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

td, th {
  border: 1px solid #dddddd;
  text-align: left;
  padding: 8px;
}

tr:nth-child(odd) {
  background-color: #dddddd;
}
</style>

<script>

var stop_array = ["200","400","111","114","115","117","118"];


function copyToClipboard(textarea_id){

  var textarea = document.getElementById(textarea_id);
  textarea.focus();
  textarea.setSelectionRange(0,textarea.value.length);

  document.execCommand("copy");

}

function refresh(task_url){

    $.ajax({
        type: 'GET',
        url: task_url,
        success: function(data){

          $("#data").empty();

          /*$("#taskid").text(data['task']['hash_id']);*/
          /*$("#user").text(data['task']['user']);*/
          /*$("#service").text(data['task']['service']);*/

          $("#status").text(data['task']['status']);
          $("#description").text(data['task']['description']);
          $("#last_modify").text(data['task']['last_modify']);

          /* ask first for microservice == storage*/
          if (data['task']['service'].localeCompare("storage") == 0 ){

            // DOWNLOAD received download URL:
            if (data['task']['status'].localeCompare("117") == 0){

              $("#data").text("Use this link to download the file:");
              $("#data").wrapInner("<a href='"+data['task']['data']+"'>download</a>");

            } else if (data['task']['status'].localeCompare("111") == 0){ /*UPLOAD: received temp url form*/

               $("<p>Use this command to upload your file to staging area</p>").appendTo($("#data"));
               $("<br>").appendTo($("#data"));
               $("<div id='copy_button'></div>").appendTo($("#data"));
               $("#copy_button").wrapInner("<input type='button' onclick='copyToClipboard(\'upload_command\');' value='Copy to clipboard'/>");
               

               $("<div id='curl_command'></div>").appendTo($("#data"));
               $("#curl_command").wrapInner("<textarea style='width: 100%; height:100%;' id='upload_command'>"+data['task']['data']['msg']['command']+"</textarea>");
   	       $("<div id='to-upload-finish'></div>").appendTo($("#data"));
               $("<p>If upload to staging area has finished, start the process to transfer the file to CSCS:</p>").appendTo($("#to-upload-finish"));
               $("#to-upload-finish").wrapInner("<a href='../storage/upload-finished/"+data['task']['hash_id']+"'>Finish the upload process</a>");

               
                              
            }

          } else { /*service == "compute"*/
            $("#data").text(data['task']['data']);
          }


          if (stop_array.indexOf(data['task']['status']) != -1){
            /* if status is not updated anymore */
            clearInterval(refreshTask);

          }

         },

        error: function(data){return;},
    });




}
</script>

<h1>
  Displaying FirecREST tasks
</h1>


{% if response.json()['task']['status'] in ["100","110","112","113", "116"] %}
  <script>
    var refreshTask = setInterval(function() {
          refresh("/tasks/{{ response.json()['task']['hash_id'] }}?data=1");
        }, 3000);
  </script>
{% endif %}


<table>
  <tr><td><b>Task ID</b></td><td id="taskid">{{ response.json()['task']['hash_id'] }}</td></tr>
  <tr><td><b>User</b></td><td id="user">{{ response.json()['task']['user'] }}</td></tr>
  <tr><td><b>Service</b></td><td id="service">{{ response.json()['task']['service'] }}</td></tr>
  <tr><td><b>Status Code</b></td><td id="status">{{ response.json()['task']['status'] }}</td></tr>
  <tr><td><b>Description</b></td><td id="description">{{ response.json()['task']['description'] }}</td></tr>
  <tr><td><b>Last Modify</b></td><td  id="last_modify">{{ response.json()['task']['last_modify'] }}</td></tr>
  <tr><td colspan="2"><b>Actions on the tasks</b></td></tr>
  <tr><td colspan="2" id="data">
  {% if response.json()['task']['service'] != None %}
    {% if response.json()['task']['service'] == "storage" %} {# if is storage #}
      {% if response.json()['task']['status'] == "117" %} {# received temp url for download #}
        <div id="status-117">
         Use this link to download the file: <a href="{{ response.json()['task']['data']  }}">download</a>
        </div>
      {% elif response.json()['task']['status'] == "111"  %} {# received temp url for upload #}


      <div id="status-111">
        <p>Use this command to upload your file to staging area</p>
        <input type="button" onclick="copyToClipboard('upload_command');" value="Copy to clipboard"/>
        <textarea style="width: 100%; height:100%;" id="upload_command">{{ response.json()['task']['data']['msg']['command'] }}</textarea>
        <p>If upload to staging area has finished, start the process to transfer the file to CSCS:</p>
        <a href="../storage/upload-finished/{{ response.json()['task']['hash_id'] }}">Finish the upload process</a>
      </div>
      {% else %}
        <div id="status-ready">
          No actions can be performed with this status code.
        </div>
      {% endif %} {# end storage #}
    {% elif response.json()['task']['service'] == "compute"  %} {# if is compute #}

        {{ response.json()['task']['data'] }}

    {% endif %} {# END if service #}
  {% endif %}
  </td></tr>

</table>
{% endblock %}
